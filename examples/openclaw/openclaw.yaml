# OpenClaw on SkyPilot - Personal AI Assistant in an Isolated Cloud Sandbox
#
# OpenClaw (https://github.com/openclaw/openclaw) is a personal AI assistant
# that connects to messaging platforms (WhatsApp, Telegram, Slack, Discord,
# and more) while running on your own infrastructure.
#
# This example deploys OpenClaw's gateway on a cloud VM via SkyPilot,
# providing an isolated sandbox environment separate from your local machine.
# Access the built-in WebChat interface via SSH tunnel for secure access.
#
# All state (config, credentials, conversation history, WhatsApp session,
# workspace files) is persisted to an S3 bucket so you can tear down and
# relaunch without losing anything.
#
# Prerequisites:
#   An Anthropic API key (https://console.anthropic.com/)
#   AWS credentials configured for S3 access (sky check)
#   An S3 bucket for state persistence (aws s3 mb s3://openclaw-state)
#
# Usage:
#   # Launch the gateway:
#   sky launch -c openclaw openclaw.yaml --env ANTHROPIC_API_KEY
#
#   # Open an SSH tunnel to access WebChat securely:
#   ssh -L 18789:localhost:18789 openclaw
#
#   # Open WebChat in your browser:
#   open http://localhost:18789
#
#   # SSH in to run the onboarding wizard for additional channels:
#   ssh openclaw
#   openclaw onboard
#
#   # Tear down when done — all state is preserved in the S3 bucket:
#   sky down openclaw
#
#   # Relaunch later — picks up right where you left off:
#   sky launch -c openclaw openclaw.yaml --env ANTHROPIC_API_KEY

resources:
  cpus: 2+
  memory: 4+

envs:
  # Anthropic API key (pass via --env ANTHROPIC_API_KEY=sk-ant-...)
  ANTHROPIC_API_KEY:
  # S3 bucket name for persisting all OpenClaw state.
  # Change this to use your own bucket name.
  OPENCLAW_BUCKET: openclaw-state

file_mounts:
  # Persist all OpenClaw state to an S3 bucket across cluster
  # teardowns and relaunches. Uses MOUNT_CACHED (rclone) instead of
  # MOUNT (goofys) because OpenClaw uses appendFileSync for session
  # transcripts, which requires full POSIX write support.
  ~/.openclaw:
    source: s3://${OPENCLAW_BUCKET}
    mode: MOUNT_CACHED

setup: |
  # Install Node.js 22 (required by OpenClaw)
  if ! node --version 2>/dev/null | grep -q "v22"; then
    curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
    sudo apt-get install -y nodejs
  fi

  # Install OpenClaw
  sudo npm install -g openclaw@latest

  # Only write configuration on first launch.
  # On subsequent launches the S3-backed mount already has our config.
  if [ ! -f ~/.openclaw/openclaw.json ]; then
    GATEWAY_TOKEN=$(openssl rand -hex 16)
    echo "=========================================="
    echo "First launch — generating new WebChat token: $GATEWAY_TOKEN"
    echo "=========================================="

    cat > ~/.openclaw/openclaw.json << EOF
  {
    "agents": {
      "defaults": {
        "model": {
          "primary": "anthropic/claude-opus-4-6"
        }
      }
    },
    "gateway": {
      "mode": "local",
      "auth": {
        "mode": "token",
        "token": "$GATEWAY_TOKEN"
      }
    }
  }
  EOF
  else
    echo "=========================================="
    echo "Existing configuration found in S3 bucket — reusing."
    echo "All previous state (credentials, sessions, etc.) is intact."
    echo "=========================================="
  fi

run: |
  # Start the OpenClaw gateway
  openclaw gateway --verbose
